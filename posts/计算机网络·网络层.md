```markmap
# 网络层
## 功能概述 
- 数据报服务
    - 简单灵活 
    - 无连接
    - 尽最大努力交付
    - 为了使路由器简单
        可靠通信由传输层负责
        传送分组可能
        - 出错
        - 丢失
        - 重复
        - 失序
        - 超时
- 异构网络互连
    - 各层中继系统
        - 物理层
            - 转发器
            - 集线器
        - 数据链路层
            - 网桥
            - 交换机
        - 网络层
            - **路由器**
        - 网络层以上
            - 网关
- 路由与转发
    - 路由选择（确定哪一条路径）
        - 按照分布式算法
            根据从各相邻的路由器
            所得的关于整个网络拓扑的变化情况
            动态改变选择的路由
    - 分组转发（一个分组到达时采取的动作）
        - 根据转发表
            将用户IP数据报
            从合适端口转发出去
- SDN Software Define Network
    - 网络层定义
        - 数据平面
            - 转发
        - 控制平面
            - 路由选择
    - SDN网络
        - 数据、控制平面分离
        - 数据平面
            - 
        - 控制平面
            - 集中式
- 拥塞控制
    - 开环控制
    - 闭环控制

## 路由算法
- 静态路由算法
    - 非自适应路由算法
    - 网络管理员手动配置
    - 拓扑结构发生变化手动修改静态路由
    - 小型网络
- 动态路由算法
    - 自适应路由算法
    - 互连的路由器间彼此交换路由表
- 距离-向量算法
    - 所有节点定期
        将各自整个路由选择表
        转发到相邻节点
        - 每条路径的目的地
        - 路径的代价（距离）
        - RIP算法
- 链路状态路由算法
    - 每个参与算法的节点
        均具有完全的拓扑信息
        - 主动测试所有相邻节点
        - 定期将链路状态传播所有其他节点
    - OSPF算法
    - 洪泛法发送信息
    - 所有路由器
    - 路由器相邻的所有路由链路状态
    - 度量 metric
        - 费用
        - 距离
        - 时延
        - 带宽
    - 链路状态变化才发送
- 层次路由
    - 网络规模增大
        路由表增大
    - 整个互联网划分
        划分为很多较小的自治系统
    - 内部网关协议
        - RIP
        - OSPF
    - 外部网关协议
        - BGP
## IPV4
- IPV4分组
    - 首部长度
        - 占4位
        - 最大十进制数15
        - 最大值15 * 4B = 60B
    - 总长度
        - 首部和数据之和
        - 单位为字节
        - 以太网帧的最大传送单元
            MTU=1500B
        - 最大长度$2^{16}=65535B$
        - 标识 
            - 占16位
            - 计数器 i++
            - 数据报长度超过网络MTU
                必须分片
                此时每个数据报片
                均复制一次标识号
        - 标志
            - 占3位
            - 标志字段最低位MF
                MF=1表示后面还有分片
                MF=0表示最后一个分片
            - 标志字段中间的一位DF
                DF=0时才允许分片
        - 片偏移
            - 占13位
            - 较长的分组在分片后
                某片在原分组中相对位置
            - 以8个字节为偏移单位
            - 除最后一个分片
                每个分片的长度一定
                是8B的整数倍
        - 生存时间 TTL
            - 占8位
            - 数据报可通过路由数最大值
            - 确保分组不会永远在网络中循环
        - 协议
            - 占8位
            - TCP : 6
            - UDP : 17
        - 首部校验和
            - 占16位
            - 只校验分组的首部
            - 不校验数据部分
        - 源地址字段
            - 占4B
        - 目的地址字段
            - 占4B
- 数据报分片
    - 链路承载最大数据量
        最大传送单元MTU
    - IP数据报4000B
        首部20B 数据3980B
        MTU=1500B 标识=777
        MF=0 DF=0
        **分片大小为8B的倍数=1480**
        - 分片1
            - 标识=777 
            - 片偏移=0
            - MF=1 DF=0
            - 有效数据1480B
        - 分片2
            - 标识=777 
            - 片偏移=185
            - MF=1 DF=0
            - 有效数据1480B 
        - 分片3
            - 标识=777 
            - 片偏移=370
            - MF=0 DF=0
            - 有效数据(3980-1480*2)B
- IPV4地址
    - A类
        - 1 ~ 126
        - **0**000,0000;0;0;0 ~
            **0**111,1111;1;1;1
    - B类
        - 128 ~ 191
        - **10**00,0000;0;0;0
            **10**11,1111;1;1
    - C类
        - 192 ~ 223
        - **110**0,0000;0;0;0 ~
            **110**1,1111;1;1;1
    - D类
        - 224 ~ 239
        - **1110**,0000;0;0;0 ~
            **1110**,1111;1;1;1
    - E类
        - 240 ~ 255
        - **1111**,0000;0;0;0 ~
            **1111**,1111;1;1;1
    - IP::={<网络号>,<主机号>}
        - 主机号全为0表示本网络
        - 主机号全1表示本网络广播地址
        - 127.x.x.x为环回自检地址
        - 表示任意主机自身
        - 目的地址为127.x的
            IP数据报不会出现在任何网络
        - 32位全为0表示本网络上本主机
        - 32位全为1表示整个TCP/IP网络的广播地址
        - IP地址使用范围
            - A
                - 最大网络可用数=$2^{7}-2$
                - 第一个可用的网络号=1
                - 最后一个可用的网络号=126
                - 每个网络中最大的主机=$2^{24}-2$
            - B
                - 最大网络可用数=$2^{14}$
                - 第一个可用的网络号=128.0
                - 最后一个可用的网络号=191.255
                - 每个网络中最大的主机=$2^{16}-2$
            - C
                - 最大网络可用数=$2^{21}$
                - 第一个可用的网络号=192.0.0
                - 最后一个可用的网络号=223.255.255
                - 每个网络中最大的主机=$2^{8}-2$
- NAT
    - 专门网络地址转换为公用地址
        而对外隐藏内部管理的IP
    - 划分私有IP
        - 只用于LAN
        - 不用于WAN
        - 私有IP不能直接接入Internet
        - 通过网关利用NAT
        - 私有IP转为Internet中合法的全球IP
        - 网段
            - A
                - 1个A类
                - 10.0.0.0 ~ 10.255.255.255
            - B
                - 16个B类
                - 172.16.0.0 ~ 172.31.255.255
            - C
                - 256个C类
                - 192.168.0.0 ~ 192.168.255.255
        - 目的地址为私有IP不进行转发：本地互联网
    - NAT转换表
        - WAN : LAN
        - 138.76.29.7:5001 | 192.168.0.2:2233
    - 普通路由器转发IP数据报，不改变源IP和目的IP
    - NAT路由器转发IP数据报，一定改变
- 子网划分
    - 两级IP
        - 缺点
            - 地址空间利用率低
            - 每分配一个网络号会是路由表变得太大
            - 网络性能变坏
            - 不够灵活
    - 划分
        - 对内表现为子网划分，对外表现为没有划分的网络
        - 从主机号借用若干比特作为子网号
        - IP = {<网络号>,<子网号>,<主机号>}
        - 从其他网络发送给本单位某主机的IP
            仍然根据IP目的网络
            找到连接本单位网络的路由
            该路由收到IP
            按目的网络和子网找到目的子网
            最后交付IP至目的主机
        - 划分只根据主机号借用位作子网号
            不改变网络号
            从一个IP地址或首部无法判断是否子网划分
- 子网掩码
    - 表达对原网络主机号的借位
    - 将IP与子网掩码按位相与*AND*
    - 得到相应的子网地址
    - 要求
        - 主机设置IP地址必须设置子网掩码
        - 同属一个子网的所有主机及路由器的相应端口必须设置相同的子网掩码
        - 路由器的路由表所包含信息：目的网络地址、子网掩码、下一跳地址
- CIDR
    - 在变成子网掩码基础上消除ABC类网络划分
    - 在软件下实现超网构成
- ARP、DHCP、ICMP
## IPV6
## 路由协议
## IP组播
## 移动IP
## 网络层设备